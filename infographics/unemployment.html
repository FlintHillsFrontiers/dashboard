<h4>Flint Hills Unemployment by County</h4>
<!-- Following div sets size of infographic. This layer contains the tooltips; the next div is for the map, which is pulled underneath the tooltips with a negative margin -->
<div style="width: 960px; height: 800px;">
  <div id="tooltip" class="hidden">
    <p><strong><span id="name">100</span></strong></p>
    <p><span id="unemployed">100</span></p>
    <p><span id="rate">100</span></p>
  </div>
</div>
<!-- Following div contains the map, which is pulled underneath the tooltips with a negative margin -->
<div class="map" style="margin-top: -800px"></div>
<input type="range" id="yearRange" value="2007"  min="2007" max="2013" step="1" />
<span id="range"></span>

<script>
  var dataset;
  window.onload = function() { init() };

  var public_spreadsheet_url = 'https://docs.google.com/spreadsheet/pub?hl=en_US&hl=en_US&key=194fY194abaOe9gjopnutM0kBWpnss8-f-wod8YzrjCg&output=html';

  function init() {
    Tabletop.init( { key: public_spreadsheet_url,
                     callback: drawData,
                     simpleSheet: true } )
  }

  function drawData(dataset, tabletop) {
  
    //Width and height
    var w = 500;
    var h = 650;
    
    //Define Projection and Scale                    
    var projection = d3.geo.albersUsa()
        .scale([9000])
        .translate([w/2, h/3]);;
 
    //Define default path generator
    var path = d3.geo.path()
        .projection(projection);
        
    //Create SVG element
    var svg = d3.select(".map")
	.append("svg")
	.attr("width", w)
	.attr("height", h);
 
    //Set Color Scale, Colors taken from colorbrewer.js, included in the D3 download
    var color = d3.scale.quantile()
        .range(['rgb(26,150,65)','rgb(166,217,106)','rgb(253,174,97)','rgb(215,25,28)'])
        .domain([0.03, .08]);					
        
    //Set year at bottom of slider
    var year = document.getElementById("yearRange").value;
    document.getElementById("range").innerHTML=year;

    /*
     * The following function draws the Flint Hills counties, kansas counties, US state boundaries, and unemployment circles.
     * It also includes the function to update the unemployment circles based on year.  The functions are nested to
     * ensure proper drawing order.
     */
    
   
    d3.json("flinthills.geojson", function(json) {

	//Draw Flint Hills Counites
	svg.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("fill","#e7e7e7")
            .style("stroke","#ccc")
            .style("stroke-width","1");
            
        //Labels for Flint Hills Counties
	svg.selectAll("text")
            .data(json.features)
            .enter()
            .append("text")
            .text(function(d){
                return d.properties.NAME10;
            })
            .attr("text-anchor", "middle")
            .attr("x", function(d){
                return projection([d.properties.INTPTLON10, d.properties.INTPTLAT10])[0];
            })
	    .attr("y", function(d){
                return projection([d.properties.INTPTLON10, d.properties.INTPTLAT10])[1];
            })
            .style("fill","#000")
            .attr("text-anchor", "middle")
            .style("font-size","10px")
            .style("text-transform","uppercase");

      //Draw rest of Kansas Counties
      d3.json("ks-counties.json", function(json) {

	  //Bind data and create one path per GeoJSON feature
	  svg.selectAll("path")
	      .data(json.features)
	      .enter()
	      .append("path")
	      .attr("d", path)
	      .attr("style", "kscounty")
	      .style("fill","none")
	      .style("fill-opacity","0")
	      .style("stroke","#ddd")
	      .style("stroke-width","0.5");
        
	//Draw US states Boundaries
	d3.json("us-states.geojson", function(json) {
	  //Bind data and create one path per GeoJSON feature
	  svg.selectAll("path")
	      .data(json.features)
	      .enter()
	      .append("path")
	      .attr("d", path)
	      .style("fill","none")
	      .style("stroke","#999");
	 
   
	//Draw circles for each point
	svg.selectAll("circle")
	  //Load Data
	  .data(dataset)
	  .enter()
	  .append("circle")
	  //Place circles on centroids of counties
	  .attr("cx", function(d) {
	    return projection([d.lon, d.lat])[0];
	  })
	  .attr("cy", function(d) {
	    return projection([d.lon, d.lat])[1];
	  })
	  //Set the Radius
	  .attr("r", function(d){
	    return Math.sqrt(parseInt(d['unemp'+year.toString()]) * 0.5);    
	  })
	  //Set the Fill Color
	  .style("fill", function(d) {
	     var value = d['unemprate'+year.toString()];			   		
	     if(value) {
	      return color(value);
	     }
	     else {
	     //If value is undefined…
		return "#333";
	     }
	  })
	  .style("opacity",".75")
	    
	  //Create tooltips
	  .on("mouseover", function(d) {
	    //Get this bar's x/y values, then augment for the tooltip
	    var xPosition = parseFloat(d3.select(this).attr("cx")) +30;
	    var yPosition = parseFloat(d3.select(this).attr("cy")) -15;
		      
	    //Update the tooltip position and value
	    d3.select("#tooltip")
	      .style("left", xPosition + "px")
	      .style("top", yPosition  + "px")
	      .select("#name")
	      .text(d.name + " County");
	    d3.select("#unemployed")
	      .text("Number of Unemployed: " + numberWithCommas(d['unemp'+year.toString()]));
	    d3.select("#rate")
	      .text("Unemployment Rate: " + Math.round(d['unemprate'+year.toString()] * 1000)/10 + "%");
	  
	    //Show the tooltip
	    d3.select("#tooltip").classed("hidden", false);
	  })
	  
	  //hide tooltip on mouseout
	  .on("mouseout", function() {
	    svg.selectAll("circle").style("opacity",".75");
	    d3.select("#tooltip").classed("hidden", true);
	  }); 
	});  //End State Layer
      }); //End Kansas Counties Layer
    }); //End Flint Hills Counties Layer
    
    //Begin section for updating based on year
    
    //Listen for change on scale
    d3.select("#yearRange")
      .on("change",function(){
	//Change the year displayed
	year = document.getElementById("yearRange").value;
        document.getElementById("range").innerHTML=year;

        //Update Circles
        svg.selectAll("circle")
          .data(dataset)
          .transition()
          .duration(1000)
          .attr("cx", function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr("cy", function(d) {
            return projection([d.lon, d.lat])[1];
          })
          //Reset the Radius
          .attr("r", function(d){
            return Math.sqrt(parseInt(d['unemp'+year.toString()]) * 0.5);    
          })
          //Change the Fill Color
          .style("fill", function(d) {
            var value = d['unemprate'+year.toString()];			   		
            if(value) {
              return color(value);
            }
            else {
	      //If value is undefined…
		return "#333";
	    }
	  })
          .style("opacity",".75")
          //Update Tooltips	  
	  .on("mouseover", function(d) {
            //Get this bar's x/y values, then augment for the tooltip
            var xPosition = parseFloat(d3.select(this).attr("cx")) +30;
            var yPosition = parseFloat(d3.select(this).attr("cy")) -15;
            console.log(xPosition, yPosition);
                    
            //Update the tooltip position and value
	    d3.select("#tooltip")
              .style("left", xPosition + "px")
              .style("top", yPosition  + "px")
              .select("#name")
              .text(d.name + " County");
                      
            d3.select("#unemployed")
              .text("Number of Unemployed: " + numberWithCommas(d['unemp'+year.toString()]));
                   
            d3.select("#rate")
              .text("Unemployment Rate: " + Math.round(d['unemprate'+year.toString()] * 1000)/10 + "%");
                    
            //Show the tooltip
            d3.select("#tooltip").classed("hidden", false);
          })
          .on("mouseout", function() {
            svg.selectAll("circle").style("opacity",".75");
            //Hide the tooltip
            d3.select("#tooltip").classed("hidden", true);
          });
      });
  } //End of drawData function
 
  function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
</script>